<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Srikar Jewellers - Staff System</title>
    <link href="https://fonts.googleapis.com/css2?family=Cormorant+Garamond:wght@700&family=Poppins:wght@300;400;500;600&display=swap" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <style>
        :root {
            --gold-primary: #DCCA87;
            --gold-secondary: #F5EFE1;
            --dark-bg: #0C0C0C;
            --dark-secondary: #181818;
            --text-primary: #FFFFFF;
            --text-secondary: #AAAAAA;
            --priority-high: #d9534f;
            --priority-medium: #f0ad4e;
            --priority-low: #5cb85c;
            --transition-fast: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: 'Poppins', sans-serif; background-color: var(--dark-bg); color: var(--text-secondary); min-height: 100vh; }
        .hidden { display: none !important; }
        .active { display: block !important; }

        /* --- Login Screen --- */
        .login-container { display: flex; align-items: center; justify-content: center; min-height: 100vh; padding: 2rem; }
        .login-box { width: 100%; max-width: 450px; background: var(--dark-secondary); border: 1px solid rgba(220, 202, 135, 0.15); border-radius: 15px; padding: 3rem; text-align: center; }
        .logo { width: 90px; height: 90px; border-radius: 50%; border: 3px solid var(--gold-primary); box-shadow: 0 0 25px rgba(220, 202, 135, 0.2); margin: 0 auto 1rem auto; object-fit: cover; }
        .login-title { font-family: 'Cormorant Garamond', serif; font-size: 3rem; color: var(--gold-primary); }
        .login-subtitle { margin-bottom: 2.5rem; font-size: 1.1rem; }
        #login-error { color: var(--priority-high); margin-top: 1rem; min-height: 1.2em; }

        /* --- Main App Layout --- */
        .main-container { max-width: 1200px; margin: 2rem auto; background: var(--dark-secondary); border: 1px solid rgba(220, 202, 135, 0.15); border-radius: 20px; overflow: hidden; }
        .header { padding: 2.5rem; background: #111111; border-bottom: 1px solid rgba(220, 202, 135, 0.15); display: flex; align-items: center; justify-content: space-between; flex-wrap: wrap; gap: 1rem; }
        .header-text h1 { font-family: 'Cormorant Garamond', serif; font-size: 2.5rem; color: var(--gold-primary); }
        #header-nav { display: flex; gap: 10px; flex-wrap: wrap; align-items: center; }
        .content-area { padding: 2.5rem; }
        .view { display:none; animation: fadeIn 0.5s ease-in-out; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }

        /* --- Cards & Forms --- */
        .section-title { font-family: 'Cormorant Garamond', serif; font-size: 2.2rem; color: var(--gold-primary); margin-bottom: 2rem; text-align: center; }
        .premium-card { background: #111111; border: 1px solid rgba(220, 202, 135, 0.1); border-radius: 15px; padding: 2rem; margin-bottom: 2.5rem; }
        .form-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 1.5rem; }
        .form-group { display: flex; flex-direction: column; text-align: left; }
        .form-group label { margin-bottom: 0.75rem; font-weight: 500; color: var(--gold-secondary); font-size: 0.9rem; text-transform: uppercase; }
        .form-group input, .form-group select { width: 100%; padding: 0.8rem 1rem; border: 1px solid rgba(220, 202, 135, 0.2); border-radius: 8px; font-size: 1rem; font-family: 'Poppins', sans-serif; background: var(--dark-secondary); color: var(--text-primary); transition: var(--transition-fast); }
        .form-group input:focus, .form-group select:focus { outline: none; border-color: var(--gold-primary); }
        .form-group input[type="checkbox"] { width: auto; margin-right: 10px; }

        /* --- Buttons --- */
        .btn { padding: 0.8rem 1.8rem; border: 1px solid var(--gold-primary); border-radius: 8px; cursor: pointer; font-size: 1rem; font-weight: 600; text-transform: uppercase; transition: var(--transition-fast); display: inline-flex; align-items: center; gap: 0.75rem; justify-content: center; }
        .btn-primary { background: var(--gold-primary); color: var(--dark-bg); }
        .btn-primary:hover { background: #EADCA6; }
        .btn-secondary { background: transparent; color: var(--gold-primary); }
        .btn-secondary:hover { background: rgba(220,202,135,0.1); }
        .btn-danger { background: var(--priority-high); color: white; border-color: var(--priority-high); }
        .btn-danger:hover { background: #c9302c; }
        .btn.nav-btn { background: transparent; color: var(--gold-primary); text-transform: none; font-size: 0.9rem; padding: 0.6rem 1rem; }
        .btn.nav-btn:hover, .btn.nav-btn.active { background: var(--gold-primary); color: var(--dark-bg); }
        .btn:disabled, .btn.disabled { background: #333; border-color: #444; color: #777; cursor: not-allowed; }

        /* --- Stats Grid --- */
        .stats-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 20px; margin-bottom: 2.5rem; }
        .stat-card { background: #111; padding: 25px; border-radius: 15px; text-align: center; border-top: 3px solid var(--gold-primary); }
        .stat-card h3 { font-family: 'Cormorant Garamond', serif; color: var(--gold-secondary); margin-bottom: 10px; font-size: 1.2rem; }
        .stat-number { font-size: 2.5rem; font-weight: bold; color: var(--text-primary); display: block; margin-top: 10px; }

        /* --- Task List --- */
        .task-item { display: flex; flex-wrap: wrap; justify-content: space-between; align-items: center; gap: 1rem; padding: 1.2rem 1rem; background: #1C1C1C; border-radius: 8px; margin-bottom: 1rem; border-left: 5px solid var(--text-secondary); }
        .task-status-selector { background: var(--dark-secondary); color: var(--text-primary); border: 1px solid rgba(220, 202, 135, 0.2); border-radius: 5px; padding: 5px; font-family: 'Poppins', sans-serif; font-size: 0.9rem;}
        .task-item.Urgent { border-left-color: var(--priority-high); }
        .task-item.Important { border-left-color: var(--priority-medium); }
        .task-item.Not-Important { border-left-color: var(--priority-low); }
        .task-title { font-weight: 600; color: var(--text-primary); }
        .role { font-weight: 600; text-transform: capitalize; }

        /* --- Attendance --- */
        .attendance-controls { display: flex; justify-content: center; align-items: center; gap: 20px; flex-wrap: wrap; margin-bottom: 2rem; }
        .break-buttons { display: flex; gap: 10px; }
        #attendance-status-grid .stat-card, #attendance-avg-grid .stat-card { border-top-color: var(--priority-low); }
        #attendance-status-grid .stat-number, #attendance-avg-grid .stat-number { font-size: 1.8rem; }

        /* --- Performance Table --- */
        .performance-table { width: 100%; border-collapse: collapse; margin-top: 1rem; }
        .performance-table th, .performance-table td { padding: 12px 15px; text-align: left; border-bottom: 1px solid rgba(220, 202, 135, 0.1); }
        .performance-table th { color: var(--gold-primary); font-size: 0.9rem; text-transform: uppercase; }
        .performance-table .rank { font-weight: bold; font-size: 1.2rem; color: var(--gold-primary); }

        /* --- Notification Bell & Panel --- */
        .notification-bell { position: relative; background: none; border: none; color: var(--gold-primary); font-size: 1.5rem; cursor: pointer; }
        .notification-dot { position: absolute; top: 0; right: 0; width: 8px; height: 8px; background: var(--priority-high); border-radius: 50%; display: none; }
        .notification-dot.visible { display: block; }
        #notification-panel { position: absolute; top: 80px; right: 20px; width: 350px; max-height: 400px; background: var(--dark-secondary); border: 1px solid rgba(220, 202, 135, 0.15); border-radius: 10px; box-shadow: 0 10px 30px rgba(0,0,0,0.5); overflow-y: auto; z-index: 1001; }
        .notification-item { padding: 15px; border-bottom: 1px solid rgba(220, 202, 135, 0.1); }
        .notification-item:last-child { border-bottom: none; }
        .notification-item.unread { background: #1c1c1c; font-weight: bold; }
    </style>
</head>
<body>
    <div id="login-page" class="active">
        <div class="login-container">
            <div class="login-box">
                <img src="logo.jpeg" alt="Srikar Jewellers Logo" class="logo">
                <h1 class="login-title">Srikar Jewellers</h1>
                <p class="login-subtitle">Staff Portal</p>
                <div class="form-group"><label for="login-email">Email Address</label><input type="email" id="login-email"></div>
                <div class="form-group"><label for="login-password">Password</label><input type="password" id="login-password"></div>
                <button id="login-button" class="btn btn-primary"><i class="fas fa-sign-in-alt"></i> Secure Login</button>
                <p id="login-error"></p>
            </div>
        </div>
    </div>

    <div id="app-page" class="hidden">
        <div class="main-container">
            <header id="app-header" class="header">
                <div class="header-text"><h1 id="header-title">Dashboard</h1><p id="header-subtitle">Srikar Jewellers</p></div>
                <nav id="header-nav"></nav>
            </header>

            <main id="app-main" class="content-area">
                <div id="admin-dashboard-view" class="view hidden">
                    <div class="premium-card">
                        <h2 class="section-title">Assign New Task</h2>
                        <form id="assign-task-form" class="form-grid">
                            <div class="form-group"><label>Task Title</label><input type="text" id="task-title" required></div>
                            <div class="form-group"><label>Assign To</label><select id="task-assignee" required></select></div>
                            <div class="form-group"><label>Priority</label><select id="task-priority"><option value="Important">Important</option><option value="Urgent">Urgent</option><option value="Not Important">Not Important</option></select></div>
                            <div class="form-group"><label>Deadline</label><input type="datetime-local" id="task-deadline" required></div>
                        </form>
                        <div class="form-group"><label><input type="checkbox" id="task-recurring"> Daily Recurring Task</label></div>
                        <div style="text-align: center; margin-top: 1.5rem;"><button id="assign-task-button" class="btn btn-primary"><i class="fas fa-paper-plane"></i> Assign Task</button></div>
                    </div>
                    <div class="premium-card"><h2 class="section-title">All Active Tasks</h2><div id="admin-task-list"></div></div>
                </div>

                <div id="admin-performance-view" class="view hidden">
                    <div class="premium-card"><h2 class="section-title">Staff Performance & Rankings</h2><div id="performance-table-container"></div></div>
                </div>

                <div id="staff-dashboard-view" class="view hidden">
                    <div class="premium-card"><h2 class="section-title">My Tasks</h2><div id="staff-task-list"></div></div>
                </div>
                
                <div id="staff-attendance-view" class="view hidden">
                    <div class="premium-card">
                        <h2 class="section-title">My Attendance</h2>
                        <div class="attendance-controls">
                            <button id="clock-in-btn" class="btn btn-primary">Clock In</button>
                            <button id="clock-out-btn" class="btn btn-danger hidden">Clock Out</button>
                            <div class="break-buttons">
                                <button id="lunch-out-btn" class="btn btn-secondary disabled">Lunch Out</button>
                                <button id="lunch-in-btn" class="btn btn-secondary hidden">Lunch In</button>
                                <button id="snack-out-btn" class="btn btn-secondary disabled">Snack Out</button>
                                <button id="snack-in-btn" class="btn btn-secondary hidden">Snack In</button>
                            </div>
                        </div>
                        <div id="attendance-status-grid" class="stats-grid"></div>
                    </div>
                    <div class="premium-card"><h2 class="section-title">My Time Averages (Last 30 Days)</h2><div id="attendance-avg-grid" class="stats-grid"></div></div>
                </div>
            </main>
        </div>
        <div id="notification-panel" class="hidden"><div id="notification-list"></div></div>
    </div>

    <script type="module">
        // --- 1. INITIALIZE FIREBASE ---
        import { initializeApp } from "https://www.gstatic.com/firebasejs/9.6.1/firebase-app.js";
        import { getAuth, signInWithEmailAndPassword, signOut, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/9.6.1/firebase-auth.js";
        import { getFirestore, collection, doc, addDoc, setDoc, getDoc, getDocs, onSnapshot, query, where, orderBy, serverTimestamp, Timestamp, writeBatch, updateDoc, limit } from "https://www.gstatic.com/firebasejs/9.6.1/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyBJkFO2l12n4hKLbNd1vEMgz87GFzH77lg",
            authDomain: "srikar-jewellers-crm.firebaseapp.com",
            projectId: "srikar-jewellers-crm",
            storageBucket: "srikar-jewellers-crm.firebasestorage.app",
            messagingSenderId: "377625912262",
            appId: "1:377625912262:web:d6d05bec0d817e211b48c7",
            measurementId: "G-06K93QM4V4"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        // --- GLOBAL STATE & ELEMENTS ---
        let currentUser = null;
        let currentUserRole = 'staff';
        const loginPage = document.getElementById('login-page');
        const appPage = document.getElementById('app-page');
        const loginButton = document.getElementById('login-button');
        const loginEmailInput = document.getElementById('login-email');
        const loginPasswordInput = document.getElementById('login-password');
        const loginError = document.getElementById('login-error');

        // --- PAGE NAVIGATION ---
        const showView = (viewId) => {
            appPage.querySelectorAll('.view').forEach(v => v.classList.remove('active'));
            document.getElementById(viewId)?.classList.add('active');
        };

        // --- AUTHENTICATION ---
        onAuthStateChanged(auth, async (user) => {
            if (user) {
                currentUser = user;
                const userDoc = await getDoc(doc(db, 'users', user.uid));
                if (userDoc.exists()) {
                    currentUser.displayName = userDoc.data().name;
                    currentUserRole = userDoc.data().role || 'staff';
                }
                loginPage.classList.remove('active');
                appPage.classList.add('active');
                setupDashboard();
                if(currentUserRole === 'admin') checkAndCreateRecurringTasks();
            } else {
                currentUser = null;
                loginPage.classList.add('active');
                appPage.classList.remove('active');
            }
        });

        loginButton.addEventListener('click', () => {
            signInWithEmailAndPassword(auth, loginEmailInput.value, loginPasswordInput.value)
                .catch(() => loginError.textContent = 'Invalid email or password.');
        });
        const logout = () => signOut(auth);

        // --- DASHBOARD SETUP ---
        const setupDashboard = () => {
            const headerNav = document.getElementById('header-nav');
            const headerSubtitle = document.getElementById('header-subtitle');
            headerNav.innerHTML = '';
            
            if (currentUserRole === 'admin') {
                document.getElementById('header-title').textContent = "Admin Dashboard";
                headerSubtitle.textContent = `Welcome, ${currentUser.displayName || currentUser.email}`;
                headerNav.innerHTML = `
                    <button class="btn nav-btn active" data-view="admin-dashboard-view">Dashboard</button>
                    <button class="btn nav-btn" data-view="admin-performance-view">Performance</button>
                    <button id="logout-btn" class="btn btn-danger">Logout</button>`;
                showView('admin-dashboard-view');
                initializeAdminDashboard();
            } else {
                document.getElementById('header-title').textContent = "Staff Dashboard";
                headerSubtitle.textContent = `Welcome, ${currentUser.displayName || currentUser.email}`;
                headerNav.innerHTML = `
                    <button class="btn nav-btn active" data-view="staff-dashboard-view">My Tasks</button>
                    <button class="btn nav-btn" data-view="staff-attendance-view">Attendance</button>
                    <div id="notification-bell-container"></div>
                    <button id="logout-btn" class="btn btn-danger">Logout</button>`;
                showView('staff-dashboard-view');
                initializeStaffDashboard();
            }
            
            headerNav.querySelectorAll('.nav-btn').forEach(btn => {
                btn.addEventListener('click', (e) => {
                    headerNav.querySelectorAll('.nav-btn').forEach(b => b.classList.remove('active'));
                    e.target.classList.add('active');
                    showView(e.target.dataset.view);
                });
            });
            headerNav.querySelector('#logout-btn').addEventListener('click', logout);
        };

        // --- ADMIN FEATURES ---
        const initializeAdminDashboard = () => {
            const assignTaskButton = document.getElementById('assign-task-button');
            assignTaskButton.addEventListener('click', async () => {
                const assignedToUID = document.getElementById('task-assignee').value;
                const assigneeSelect = document.getElementById('task-assignee');
                const assignedToName = assigneeSelect.options[assigneeSelect.selectedIndex].text;

                const task = {
                    title: document.getElementById('task-title').value,
                    assignedToUID: assignedToUID,
                    assignedToName: assignedToName,
                    priority: document.getElementById('task-priority').value,
                    deadline: Timestamp.fromDate(new Date(document.getElementById('task-deadline').value)),
                    isRecurring: document.getElementById('task-recurring').checked,
                    status: 'Pending',
                    createdAt: serverTimestamp()
                };
                if (!task.title || !task.assignedToUID || !document.getElementById('task-deadline').value) return alert('Title, Assignee, and Deadline are required.');
                
                const taskRef = await addDoc(collection(db, 'tasks'), task);
                
                await addDoc(collection(db, 'users', task.assignedToUID, 'notifications'), {
                    message: `New task assigned: "${task.title}"`,
                    isRead: false,
                    createdAt: serverTimestamp()
                });
                alert('Task assigned successfully!');
                document.getElementById('assign-task-form').reset();
            });

            onSnapshot(collection(db, 'users'), snapshot => {
                const assigneeSelect = document.getElementById('task-assignee');
                assigneeSelect.innerHTML = '<option value="">Select Staff...</option>';
                snapshot.forEach(doc => {
                    const user = doc.data();
                    if (user.role !== 'admin') {
                        assigneeSelect.innerHTML += `<option value="${user.uid}">${user.name || user.email}</option>`;
                    }
                });
            });

            const adminTaskList = document.getElementById('admin-task-list');
            onSnapshot(query(collection(db, 'tasks'), where('status', '!=', 'Completed')), snapshot => {
                adminTaskList.innerHTML = snapshot.empty ? '<p>No active tasks.</p>' : '';
                snapshot.docs.forEach(doc => renderTaskItem(adminTaskList, { id: doc.id, ...doc.data() }));
            });
            
            document.querySelector('[data-view="admin-performance-view"]').addEventListener('click', renderPerformanceDashboard);
        };

        // --- STAFF FEATURES ---
        const initializeStaffDashboard = () => {
            const staffTaskList = document.getElementById('staff-task-list');
            const q = query(collection(db, 'tasks'), where('assignedToUID', '==', currentUser.uid), orderBy('deadline', 'asc'));
            onSnapshot(q, snapshot => {
                staffTaskList.innerHTML = snapshot.empty ? '<p>You have no tasks assigned.</p>' : '';
                snapshot.docs.forEach(doc => renderTaskItem(staffTaskList, { id: doc.id, ...doc.data() }));
            });
            
            setupNotifications();
            document.querySelector('[data-view="staff-attendance-view"]').addEventListener('click', setupAttendancePage);
        };

        // --- TASK RENDERING & STATUS UPDATE ---
        const renderTaskItem = (container, task) => {
            const item = document.createElement('div');
            item.className = `task-item ${task.priority.replace(' ', '-')} ${task.status}`;
            const deadline = task.deadline.toDate().toLocaleString('en-IN');
            const statusOptions = ['Pending', 'Started', 'In Progress', 'Completed'];
            
            let actionsHtml = (currentUserRole === 'staff')
                ? `<select class="task-status-selector" data-taskid="${task.id}">${statusOptions.map(opt => `<option value="${opt}" ${task.status === opt ? 'selected' : ''}>${opt}</option>`).join('')}</select>`
                : `<div class="task-assignee-info">To: ${task.assignedToName}</div><span class="role">${task.status}</span>`;

            item.innerHTML = `<div><div class="task-title">${task.title}</div><small>Deadline: ${deadline}</small></div><div>${actionsHtml}</div>`;
            container.appendChild(item);

            if (currentUserRole === 'staff') {
                item.querySelector('.task-status-selector').addEventListener('change', e => {
                    const newStatus = e.target.value;
                    const taskRef = doc(db, 'tasks', task.id);
                    const updateData = { status: newStatus };
                    if (newStatus === 'Started' && !task.startedAt) updateData.startedAt = serverTimestamp();
                    if (newStatus === 'Completed' && !task.completedAt) updateData.completedAt = serverTimestamp();
                    updateDoc(taskRef, updateData);
                });
            }
        };

        // --- NOTIFICATIONS ---
        const setupNotifications = () => {
            const bellContainer = document.getElementById('notification-bell-container');
            bellContainer.innerHTML = `<button id="notification-bell" class="notification-bell"><i class="fas fa-bell"></i><span id="notification-dot" class="notification-dot"></span></button>`;
            
            const bell = document.getElementById('notification-bell');
            const dot = document.getElementById('notification-dot');
            const panel = document.getElementById('notification-panel');

            const q = query(collection(db, 'users', currentUser.uid, 'notifications'), orderBy('createdAt', 'desc'));
            onSnapshot(q, (snapshot) => {
                const notifs = snapshot.docs;
                const unreadCount = notifs.filter(d => !d.data().isRead).length;
                dot.classList.toggle('visible', unreadCount > 0);
                
                const list = document.getElementById('notification-list');
                list.innerHTML = notifs.length === 0 ? '<div class="notification-item">No new notifications.</div>' : '';
                notifs.forEach(doc => {
                    const notif = doc.data();
                    const item = document.createElement('div');
                    item.className = `notification-item ${!notif.isRead ? 'unread' : ''}`;
                    item.innerHTML = `<p>${notif.message}</p><small>${notif.createdAt.toDate().toLocaleString('en-IN')}</small>`;
                    list.appendChild(item);
                });
            });

            bell.addEventListener('click', async () => {
                panel.classList.toggle('hidden');
                if (!panel.classList.contains('hidden')) {
                    const notifsRef = collection(db, 'users', currentUser.uid, 'notifications');
                    const unreadQuery = query(notifsRef, where('isRead', '==', false));
                    const unreadSnapshot = await getDocs(unreadQuery);
                    const batch = writeBatch(db);
                    unreadSnapshot.forEach(doc => batch.update(doc.ref, { isRead: true }));
                    await batch.commit();
                }
            });
        };

        // --- ATTENDANCE ---
        const setupAttendancePage = () => {
            const today = new Date().toISOString().split('T')[0];
            const attendanceDocRef = doc(db, 'users', currentUser.uid, 'attendance', today);
            const buttons = {
                clockIn: document.getElementById('clock-in-btn'), clockOut: document.getElementById('clock-out-btn'),
                lunchOut: document.getElementById('lunch-out-btn'), lunchIn: document.getElementById('lunch-in-btn'),
                snackOut: document.getElementById('snack-out-btn'), snackIn: document.getElementById('snack-in-btn')
            };

            buttons.clockIn.onclick = () => setDoc(attendanceDocRef, { clockIn: serverTimestamp() }, { merge: true });
            buttons.clockOut.onclick = () => setDoc(attendanceDocRef, { clockOut: serverTimestamp() }, { merge: true });
            buttons.lunchOut.onclick = () => setDoc(attendanceDocRef, { lunchOut: serverTimestamp() }, { merge: true });
            buttons.lunchIn.onclick = () => setDoc(attendanceDocRef, { lunchIn: serverTimestamp() }, { merge: true });
            buttons.snackOut.onclick = () => setDoc(attendanceDocRef, { snackOut: serverTimestamp() }, { merge: true });
            buttons.snackIn.onclick = () => setDoc(attendanceDocRef, { snackIn: serverTimestamp() }, { merge: true });

            const grid = document.getElementById('attendance-status-grid');
            onSnapshot(attendanceDocRef, (docSnap) => {
                const data = docSnap.exists() ? docSnap.data() : {};
                const format = (ts) => ts ? ts.toDate().toLocaleTimeString('en-IN') : '--';
                
                grid.innerHTML = `
                    <div class="stat-card"><h3>Clock In</h3><span class="stat-number">${format(data.clockIn)}</span></div>
                    <div class="stat-card"><h3>Lunch Out</h3><span class="stat-number">${format(data.lunchOut)}</span></div>
                    <div class="stat-card"><h3>Lunch In</h3><span class="stat-number">${format(data.lunchIn)}</span></div>
                    <div class="stat-card"><h3>Snack Out</h3><span class="stat-number">${format(data.snackOut)}</span></div>
                    <div class="stat-card"><h3>Snack In</h3><span class="stat-number">${format(data.snackIn)}</span></div>
                    <div class="stat-card"><h3>Clock Out</h3><span class="stat-number">${format(data.clockOut)}</span></div>`;
                
                buttons.clockIn.classList.toggle('hidden', !!data.clockIn);
                buttons.clockOut.classList.toggle('hidden', !data.clockIn || !!data.clockOut);
                [buttons.lunchOut, buttons.snackOut].forEach(b => b.classList.toggle('disabled', !data.clockIn || !!data.clockOut));
                buttons.lunchOut.classList.toggle('hidden', !!data.lunchOut);
                buttons.lunchIn.classList.toggle('hidden', !data.lunchOut || !!data.lunchIn);
                buttons.snackOut.classList.toggle('hidden', !!data.snackOut);
                buttons.snackIn.classList.toggle('hidden', !data.snackOut || !!data.snackIn);
            });
            
            calculateAvgTimes();
        };

        const calculateAvgTimes = async () => {
            const avgGrid = document.getElementById('attendance-avg-grid');
            const q = query(collection(db, 'users', currentUser.uid, 'attendance'), limit(30));
            const snapshot = await getDocs(q);
            let totalLunchMins = 0, lunchCount = 0, totalSnackMins = 0, snackCount = 0;
            
            snapshot.forEach(doc => {
                const data = doc.data();
                if (data.lunchIn && data.lunchOut) {
                    totalLunchMins += (data.lunchIn.toMillis() - data.lunchOut.toMillis()) / 60000;
                    lunchCount++;
                }
                if (data.snackIn && data.snackOut) {
                    totalSnackMins += (data.snackIn.toMillis() - data.snackOut.toMillis()) / 60000;
                    snackCount++;
                }
            });
            
            const avgLunch = lunchCount ? (totalLunchMins / lunchCount).toFixed(0) : 0;
            const avgSnack = snackCount ? (totalSnackMins / snackCount).toFixed(0) : 0;
            
            avgGrid.innerHTML = `
                <div class="stat-card"><h3>Avg. Lunch Time</h3><span class="stat-number">${avgLunch} min</span></div>
                <div class="stat-card"><h3>Avg. Snack Time</h3><span class="stat-number">${avgSnack} min</span></div>`;
        };

        // --- RECURRING TASKS ---
        const checkAndCreateRecurringTasks = async () => {
            const lastCheck = localStorage.getItem('lastRecurringTaskCheck');
            const today = new Date().toISOString().split('T')[0];
            if (lastCheck === today) return;

            const q = query(collection(db, 'tasks'), where('isRecurring', '==', true), where('status', '==', 'Completed'));
            const snapshot = await getDocs(q);
            const batch = writeBatch(db);

            snapshot.forEach(doc => {
                const task = doc.data();
                const newDeadline = new Date();
                newDeadline.setHours(23, 59, 59, 999); // End of today
                
                const newTask = { ...task, deadline: Timestamp.fromDate(newDeadline), status: 'Pending', createdAt: serverTimestamp() };
                delete newTask.id; delete newTask.startedAt; delete newTask.completedAt;
                
                const newTaskRef = doc(collection(db, 'tasks'));
                batch.set(newTaskRef, newTask);
                batch.update(doc.ref, { isRecurring: false }); // Mark old one as non-recurring to avoid duplication
            });
            
            if (!snapshot.empty) await batch.commit();
            localStorage.setItem('lastRecurringTaskCheck', today);
        };

        // --- ENHANCED PERFORMANCE DASHBOARD (ADMIN) ---
        const renderPerformanceDashboard = async () => {
            const container = document.getElementById('performance-table-container');
            container.innerHTML = `<p>Calculating performance metrics...</p>`;
            
            const usersSnapshot = await getDocs(query(collection(db, 'users'), where('role', '==', 'staff')));
            const tasksSnapshot = await getDocs(query(collection(db, 'tasks'), where('status', '==', 'Completed')));
            const completedTasks = tasksSnapshot.docs.map(doc => doc.data());

            let performanceData = [];
            
            for (const userDoc of usersSnapshot.docs) {
                const user = userDoc.data();
                const userTasks = completedTasks.filter(t => t.assignedToUID === user.uid && t.startedAt && t.completedAt);
                
                const completionTimes = userTasks.map(t => (t.completedAt.toMillis() - t.startedAt.toMillis()) / 3600000); // in hours
                const avgCompletionHours = completionTimes.length ? (completionTimes.reduce((a, b) => a + b, 0) / completionTimes.length) : 0;
                
                // Calculate attendance averages
                const attendanceQuery = query(collection(db, 'users', user.uid, 'attendance'), limit(30));
                const attendanceSnapshot = await getDocs(attendanceQuery);
                
                let totalLunchMins = 0, lunchCount = 0, totalSnackMins = 0, snackCount = 0;
                let clockInTimes = [], inTimeSum = 0, inTimeCount = 0;
                
                attendanceSnapshot.forEach(doc => {
                    const data = doc.data();
                    
                    // Calculate lunch and snack averages
                    if (data.lunchIn && data.lunchOut) {
                        totalLunchMins += (data.lunchIn.toMillis() - data.lunchOut.toMillis()) / 60000;
                        lunchCount++;
                    }
                    if (data.snackIn && data.snackOut) {
                        totalSnackMins += (data.snackIn.toMillis() - data.snackOut.toMillis()) / 60000;
                        snackCount++;
                    }
                    
                    // Calculate average in-time (clock-in time)
                    if (data.clockIn) {
                        const clockInTime = data.clockIn.toDate();
                        const hours = clockInTime.getHours();
                        const minutes = clockInTime.getMinutes();
                        const timeInMinutes = hours * 60 + minutes;
                        inTimeSum += timeInMinutes;
                        inTimeCount++;
                    }
                });
                
                const avgLunchTime = lunchCount ? (totalLunchMins / lunchCount) : 0;
                const avgSnackTime = snackCount ? (totalSnackMins / snackCount) : 0;
                const avgInTime = inTimeCount ? (inTimeSum / inTimeCount) : 0;
                
                // Convert average in-time back to readable format
                const avgInHours = Math.floor(avgInTime / 60);
                const avgInMins = Math.round(avgInTime % 60);
                const avgInTimeFormatted = inTimeCount ? `${avgInHours.toString().padStart(2, '0')}:${avgInMins.toString().padStart(2, '0')}` : '--';
                
                // Simplified scoring: more tasks = better, less time = better
                const score = (userTasks.length * 10) - avgCompletionHours;
                
                performanceData.push({
                    name: user.name || user.email,
                    tasksCompleted: userTasks.length,
                    avgTime: avgCompletionHours.toFixed(2),
                    avgLunchTime: avgLunchTime.toFixed(0),
                    avgSnackTime: avgSnackTime.toFixed(0),
                    avgInTime: avgInTimeFormatted,
                    score
                });
            }

            performanceData.sort((a, b) => b.score - a.score);

            container.innerHTML = `
                <table class="performance-table">
                    <thead>
                        <tr>
                            <th>Rank</th>
                            <th>Staff Name</th>
                            <th>Tasks Completed</th>
                            <th>Avg. Completion (Hours)</th>
                            <th>Avg. Lunch Time (Min)</th>
                            <th>Avg. Snack Time (Min)</th>
                            <th>Avg. In-Time</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${performanceData.length === 0 ? '<tr><td colspan="7">No completed tasks with performance data yet.</td></tr>' : 
                          performanceData.map((p, index) => `
                            <tr>
                                <td class="rank">#${index + 1}</td>
                                <td>${p.name}</td>
                                <td>${p.tasksCompleted}</td>
                                <td>${p.avgTime}</td>
                                <td>${p.avgLunchTime}</td>
                                <td>${p.avgSnackTime}</td>
                                <td>${p.avgInTime}</td>
                            </tr>
                        `).join('')}
                    </tbody>
                </table>`;
        };
    </script>
</body>
</html>
